<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Estimation Nettoyage</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
</head>
<body class="blue-bg">
  <div id="splash" class="splash">
    <div class="drop"></div>
    <div class="splash-title">Estimation Nettoyage</div>
  </div>

  <header>
    <div class="left">
      <button id="presetIcon" class="icon-btn" title="PrÃ©-dÃ©finir piÃ¨ces" onclick="openPresets()">ğŸ”·</button>
      <div class="brand"><div class="logo-drop"></div><span>Estimation Nettoyage</span></div>
    </div>
    <div class="right">
      <button id="infoBtn" class="icon-btn" onclick="openInfo()" title="Comment Ã§a marche ?">â„¹ï¸</button>
      <button id="typesBtn" class="icon-btn" onclick="openTypeManager()" title="Gestion des types">âš™ï¸</button>
      <button id="installBtn" class="icon-btn hidden" onclick="promptInstall()" title="Installer lâ€™app">â¬‡ï¸</button>
      <select id="langSelect" onchange="setLang(this.value)"><option value="fr">FR</option><option value="en">EN</option></select>
    </div>
  </header>

  <main>
    <nav class="subnav">
      <button class="btn white small" type="button" onclick="openTypeManager()">âš™ï¸ Gestion des types</button>
    </nav>
    <div id="firstTip" class="tip hidden" data-i18n="first_tip">ğŸ’¬ Conseil : utilisez le bouton ğŸ”· pour dÃ©finir vos piÃ¨ces personnalisÃ©es (une seule fois).</div>

    <section class="card">
      <div class="row">
        <label class="flex"><span data-i18n="client">Nom client</span><input type="text" id="clientName" placeholder="Nom du client" /></label>
        <label class="flex"><span data-i18n="date">Date</span><input type="date" id="cleaningDate" /></label>
      </div>

      <div class="row">
        <label class="flex">
          <span data-i18n="type">Type de nettoyage</span>
          <div class="type-line">
            <select id="cleanType" onchange="onTypeChange()">
              <option value="Fin de chantier">Fin de chantier</option>
              <option value="Fin de bail -">Fin de bail -</option>
              <option value="Fin de bail +">Fin de bail +</option>
              <option value="Vitres & Stores">Vitres & Stores</option>
              <option value="MÃ©thodes">MÃ©thodes</option>
              <option value="Entretien rÃ©gulier - Administration">Entretien rÃ©gulier - Administration</option>
              <option value="Entretien rÃ©gulier - HÃ´pital">Entretien rÃ©gulier - HÃ´pital</option>
              <option value="Entretien rÃ©gulier - Ã‰coles">Entretien rÃ©gulier - Ã‰coles</option>
              <option value="Entretien rÃ©gulier - RÃ©sidence">Entretien rÃ©gulier - RÃ©sidence</option>
              <option value="Entretien rÃ©gulier - MÃ©dico-social">Entretien rÃ©gulier - MÃ©dico-social</option>
              <option value="__custom__">â• Ajuster une autre</option>
            </select>
<select id="globalCoefSelect" class="hidden"></select>
          </div>
        </label>
      </div>

      <!-- MÃ©thodes / Entretien : plusieurs lignes (Surface / MÂ² = H) -->
      <div id="m2hRow" class="hidden">
        <div class="m2h-header">
          <strong id="m2hTitle">MÃ©thodes</strong>
          <button class="btn white small" type="button" onclick="addM2HLine()">â• Ajouter</button>
        </div>
        <div id="m2hLines" class="m2h-lines"></div>
        <div class="m2h-note">
          <small>H = Surface / MÂ² (ex: 600 / 300 = 2h)</small>
        </div>
      </div>

      <button id="toggleAdjuster" class="toggle-btn" onclick="toggleAdjuster()">+ Ajuster</button>
      <div id="adjuster" class="adjuster hidden">
        <div class="pieces-chooser">
          <h3 data-i18n="pieces">PiÃ¨ces (prÃ©-definitions)</h3>

          <!-- âœ… Vitres & Stores : UnitÃ©s + MÂ² (avec difficultÃ©) -->
          <div id="vitresWrap" class="vitres-wrap hidden">
            <div class="vitres-grid">
              <div class="vbox">
                <h4>UnitÃ©s</h4>
                <select id="vit_u_preset"></select>
                <input id="vit_u_time" type="number" step="0.01" min="0" placeholder="Temps par unitÃ© (h)">
                <div class="vrow">
                  <input id="vit_u_norm" type="number" step="1" min="0" placeholder="QuantitÃ© normale">
                  <input id="vit_u_diff" type="number" step="1" min="0" placeholder="QuantitÃ© difficile">
                </div>
                <select id="vit_u_coef">
                  <option value="0">DifficultÃ© 0%</option>
                  <option value="0.2">DifficultÃ© 20%</option>
                  <option value="0.3">DifficultÃ© 30%</option>
                </select>
              </div>

              <div class="vbox">
                <h4>MÂ²</h4>
                <select id="vit_m2_preset"></select>
                <input id="vit_m2_cap" type="number" step="0.1" min="0" placeholder="CapacitÃ© (mÂ²/h)">
                <div class="vrow">
                  <input id="vit_m2_norm" type="number" step="0.1" min="0" placeholder="MÂ² normal">
                  <input id="vit_m2_diff" type="number" step="0.1" min="0" placeholder="MÂ² difficile">
                </div>
                <select id="vit_m2_coef">
                  <option value="0">DifficultÃ© 0%</option>
                  <option value="0.2">DifficultÃ© 20%</option>
                  <option value="0.3">DifficultÃ© 30%</option>
                </select>
              </div>
            </div>
            <div class="vitres-actions">
              <button class="btn" type="button" onclick="addVitresToSession()">Ajouter Ã  la session</button>
            </div>
          </div>

          <div id="standardList" class="standard-list"></div>
        </div>

        <div class="custom-piece">
          <h3 data-i18n="add_custom">Ajouter piÃ¨ce personnalisÃ©e</h3>
          <input type="text" id="customPieceName" placeholder="Nom (ex: Jardin d'hiver)">
          <input type="number" id="customPieceTime" placeholder="Temps par unitÃ© (h)" step="0.01" min="0">
          <input type="number" id="customPieceQty" placeholder="QuantitÃ©" step="1" min="1" value="1">
          <button class="btn" onclick="addCustomPiece()">Ajouter</button>
        </div>

        <div class="piece-list-container">
          <h3 data-i18n="list">Liste des piÃ¨ces</h3>
          <ul id="pieceList"></ul>
        </div>
      </div>

      <div class="total-section">
        <h2><span data-i18n="total">Total estimÃ© :</span> <span id="totalHours">0.00 (0:00h)</span></h2>
        <div class="team-line">
          <label class="team-label">Ã‰quipe :</label>
          <span id="teamCalc"><span id="teamTotal">0.00 (0:00h)</span> / <input id="hoursPerPerson" class="team-input" type="number" min="0" step="0.1" value="9"> = <span id="teamPeople">0.00</span></span>
        </div>
      </div>

      <div class="row">
        <label class="flex">
          <span data-i18n="remarks">Remarques :</span>
          <textarea id="remarks" placeholder="Remarques..."></textarea>
        </label>
      </div>

      <div class="actions">
        <button class="btn white" onclick="generatePDF()">PDF</button>
        <button class="btn white" onclick="resetForm()">RÃ©initialiser</button>
      </div>
    </section>
  </main>

  <div id="presetsModal" class="modal hidden">
    <div class="modal-content">
      <h2 data-i18n="presets_title">PrÃ©-dÃ©finir piÃ¨ces</h2>
      <div class="tabs" id="presetTabs">
        <button class="tab-btn active" data-tab="Fin de chantier" onclick="switchTab('Fin de chantier')">Fin de chantier</button>
        <button class="tab-btn" data-tab="Fin de bail -" onclick="switchTab('Fin de bail -')">Fin de bail -</button>
        <button class="tab-btn" data-tab="Fin de bail +" onclick="switchTab('Fin de bail +')">Fin de bail +</button>
        <button class="tab-btn" data-tab="Vitres & Stores" onclick="switchTab('Vitres & Stores')">Vitres & Stores</button>
        <button class="tab-btn" data-tab="MÃ©thodes" onclick="switchTab('MÃ©thodes')">MÃ©thodes</button>
        <button class="tab-btn" data-tab="Entretien rÃ©gulier - Administration" onclick="switchTab('Entretien rÃ©gulier - Administration')">Entretien - Administration</button>
        <button class="tab-btn" data-tab="Entretien rÃ©gulier - HÃ´pital" onclick="switchTab('Entretien rÃ©gulier - HÃ´pital')">Entretien - HÃ´pital</button>
        <button class="tab-btn" data-tab="Entretien rÃ©gulier - Ã‰coles" onclick="switchTab('Entretien rÃ©gulier - Ã‰coles')">Entretien - Ã‰coles</button>
        <button class="tab-btn" data-tab="Entretien rÃ©gulier - RÃ©sidence" onclick="switchTab('Entretien rÃ©gulier - RÃ©sidence')">Entretien - RÃ©sidence</button>
        <button class="tab-btn" data-tab="Entretien rÃ©gulier - MÃ©dico-social" onclick="switchTab('Entretien rÃ©gulier - MÃ©dico-social')">Entretien - MÃ©dico-social</button>
      </div>

      <!-- âœ… BibliothÃ¨que (catÃ©gories) : uniquement pour Fin de chantier / Fin de bail - / Fin de bail + -->
      <div id="biblioWrap" class="biblio-wrap hidden">
        <div class="biblio-grid">
          <div class="biblio-left">
            <div class="biblio-head">
              <strong>BibliothÃ¨que</strong>
              <button class="btn small" type="button" onclick="biblioAddCategory()">+ CatÃ©gorie</button>
            </div>
            <div id="biblioCats" class="biblio-cats"></div>
          </div>

          <div class="biblio-right">
            <div class="biblio-head">
              <strong id="biblioCatTitle">â€”</strong>
              <button class="btn small" type="button" onclick="biblioAddItem()">+ Item</button>
            </div>
            <div id="biblioItems" class="biblio-items"></div>
          </div>
        </div>
      </div>

      <div id="presetList" class="preset-list"></div>
      <div class="preset-add">
        <input type="text" id="presetName" placeholder="Nom piÃ¨ce (ex: Cuisine)">
        <select id="presetKind" class="hidden">
          <option value="unit">UnitÃ©s</option>
          <option value="m2">MÂ²/h</option>
        </select>
        <input type="number" id="presetTime" placeholder="Temps (h)" step="0.01" min="0">
        <input type="number" id="presetM2" class="hidden" placeholder="MÂ² (ex: 300)" step="0.1" min="0">
        <button class="btn" onclick="addPreset()">Ajouter</button>
      </div>

      <!-- âœ… Entretien - RÃ©sidence : piÃ¨ces unitaires (en plus des lignes MÂ² sur la page principale) -->
      <div id="resPiecesWrap" class="hidden">
        <div class="separator"></div>
        <h3>Entretien - RÃ©sidence : PiÃ¨ces (unitÃ©s)</h3>
        <div id="resPieceList" class="preset-list"></div>
        <div class="preset-add">
          <input type="text" id="resPieceName" placeholder="Nom piÃ¨ce (ex: Cuisine)">
          <input type="number" id="resPieceTime" placeholder="Temps (h)" step="0.01" min="0">
          <button class="btn" type="button" onclick="addResidencePiecePreset()">Ajouter</button>
        </div>
      </div>
      <div class="modal-actions">
        <button onclick="savePresets()" class="btn white">Enregistrer</button>
        <button onclick="closePresets()" class="btn white">Fermer</button>
        <button onclick="clearAllPresets()" class="btn white danger">Effacer tout presets</button>
      </div>
    </div>
  </div>

  
<div id="typesModal" class="modal hidden">
  <div class="modal-content modal-scroll">
    <div class="modal-head">
      <h2>âš™ï¸ Gestion des types</h2>
      <button class="btn white small" type="button" onclick="closeTypeManager()">Fermer</button>
    </div>

    <div class="type-manager">
      <div class="type-create">
        <h3>â• CrÃ©er un type</h3>
        <div class="row">
          <input type="text" id="tm_name" placeholder="Ex: Restaurant">
          <select id="tm_template">
            <option value="vitres">ModÃ¨le 2 blocs (comme Vitres)</option>
            <option value="m2h">MÃ©thodes / Entretien (Surface / MÂ²)</option>
            <option value="pieces_biblio">PiÃ¨ces (bibliothÃ¨que)</option>
          </select>
        </div>
        <div class="row">
          <label class="check"><input type="checkbox" id="tm_opt_pieces" checked> PiÃ¨ces (bloc gauche)</label>
          <label class="check"><input type="checkbox" id="tm_opt_m2" checked> MÂ²/h (bloc droite)</label>
          <label class="check"><input type="checkbox" id="tm_opt_coef" checked> Coef %</label>
        </div>
        <div class="row">
          <input type="number" id="tm_coef" step="1" min="0" placeholder="Coef % (ex: 20)">
          <input type="number" id="tm_d1" step="1" min="0" placeholder="DifficultÃ© 1 % (ex: 20)">
          <input type="number" id="tm_d2" step="1" min="0" placeholder="DifficultÃ© 2 % (ex: 30)">
        </div>
        <button class="btn" type="button" onclick="tmCreate()">CrÃ©er</button>
      </div>

      <div class="separator"></div>

      <div>
        <h3>Types existants</h3>
        <div id="tm_list" class="tm-list"></div>
        <small>ğŸ’¡ DÃ©sactiver = disparaÃ®t du menu, mais reste enregistrÃ©.</small>
      </div>
    </div>
  </div>
</div>

<div id="infoModal" class="modal hidden">
  <div class="modal-content info-modal">
    <h2>â„¹ï¸ Guide â€“ Comment remplir (PiÃ¨ces + mÂ²/h)</h2>

    <div class="info-accordion">
      <details open>
        <summary>âœ… Fonctionnement (2 blocs)</summary>
        <div class="info-block">
          <p><strong>Bloc 1 â€” PiÃ¨ces (UnitÃ©/h)</strong> : tÃ¢ches par division/unitÃ© (WC, cuisine, chambres, extras).</p>
          <p><strong>Bloc 2 â€” Surface (mÂ²/h)</strong> : zones grandes / entretien gÃ©nÃ©ral (sol, aspiration, passage).</p>
          <p><strong>Formules</strong> : PiÃ¨ces = h/unitÃ© Ã— quantitÃ© â€¢ Surface = mÂ² Ã· (mÂ²/h) â€¢ Total = PiÃ¨ces + Surface.</p>
          <p><strong>Affichage</strong> : le total apparaÃ®t en dÃ©cimal + format horaire automatique : <strong>2.25 (2:15h)</strong>.</p>
        </div>
      </details>

      <details>
        <summary>ğŸ§® Exemples (Entretien rÃ©sidence)</summary>
        <div class="info-block">
          <h4>Exemple A â€” T3 80mÂ²</h4>
          <table class="info-table">
            <thead><tr><th>PiÃ¨ce</th><th>h/unitÃ©</th><th>QtÃ©</th><th>Total</th></tr></thead>
            <tbody>
              <tr><td>WC</td><td>0.75</td><td>2</td><td>1.50</td></tr>
              <tr><td>Cuisine</td><td>1.50</td><td>1</td><td>1.50</td></tr>
              <tr><td>Chambre</td><td>0.50</td><td>3</td><td>1.50</td></tr>
              <tr><td>Salon</td><td>0.75</td><td>1</td><td>0.75</td></tr>
              <tr><td colspan="3"><strong>Subtotal PiÃ¨ces</strong></td><td><strong>5.25</strong></td></tr>
            </tbody>
          </table>
          <table class="info-table">
            <thead><tr><th>Surface</th><th>mÂ²</th><th>CapacitÃ© (mÂ²/h)</th><th>Total</th></tr></thead>
            <tbody>
              <tr><td>Appartement</td><td>80</td><td>40</td><td>2.00</td></tr>
              <tr><td colspan="3"><strong>Subtotal Surface</strong></td><td><strong>2.00</strong></td></tr>
            </tbody>
          </table>
          <p><strong>Total</strong> = 5.25 + 2.00 = <strong>7.25 (7:15h)</strong></p>

          <h4>Exemple B â€” 40mÂ²</h4>
          <p>PiÃ¨ces: 1 WC (0.75Ã—1=0.75) + 1 cuisine (1.00Ã—1=1.00) â†’ <strong>1.75</strong><br>
             Surface: 40 Ã· 60 = <strong>0.67</strong><br>
             Total: <strong>2.42 (2:25h)</strong></p>
        </div>
      </details>

      <details>
        <summary>ğŸ“ CapacitÃ©s recommandÃ©es (mÂ²/h)</summary>
        <div class="info-block">
          <table class="info-table">
            <thead><tr><th>Type</th><th>mÂ²/h recommandÃ©</th></tr></thead>
            <tbody>
              <tr><td>Entretien normal</td><td>45 â€“ 70</td></tr>
              <tr><td>Entretien lourd</td><td>30 â€“ 50</td></tr>
              <tr><td>Fin de bail (rapide par surface)</td><td>15 â€“ 35</td></tr>
              <tr><td>Fin de chantier</td><td>8 â€“ 28</td></tr>
            </tbody>
          </table>
        </div>
      </details>

      <details>
        <summary>ğŸ§¾ RÃ©fÃ©rence NÂ°1 â€” Heures par piÃ¨ce</summary>
        <div class="info-block">
          <table class="info-table">
            <thead><tr><th>PiÃ¨ce</th><th>Fin de bail (moy.)</th><th>TrÃ¨s sale</th><th>Fin de chantier</th></tr></thead>
            <tbody>
              <tr><td>Cuisine</td><td>4â€“6h</td><td>7â€“9h</td><td>5â€“7h</td></tr>
              <tr><td>Salle de bain</td><td>3â€“4h</td><td>4â€“6h</td><td>4â€“5h</td></tr>
              <tr><td>WC</td><td>1.5â€“2h</td><td>2â€“3h</td><td>2â€“3h</td></tr>
              <tr><td>Salon / SÃ©jour</td><td>3â€“4h</td><td>4â€“5h</td><td>4â€“6h</td></tr>
              <tr><td>Chambre (par piÃ¨ce)</td><td>2â€“3h</td><td>3â€“4h</td><td>3â€“4h</td></tr>
              <tr><td>Couloir / EntrÃ©e</td><td>1â€“2h</td><td>2â€“3h</td><td>2â€“3h</td></tr>
              <tr><td>Finitions / contrÃ´le</td><td>1â€“2h</td><td>2â€“3h</td><td>3â€“5h</td></tr>
            </tbody>
          </table>
          <p class="muted">Les vitres/stores sont comptÃ©s sÃ©parÃ©ment.</p>
        </div>
      </details>

      <details>
        <summary>ğŸªŸ RÃ©fÃ©rence NÂ°2 â€” Vitres & Stores</summary>
        <div class="info-block">
          <table class="info-table">
            <thead><tr><th>Type</th><th>Fin de bail</th><th>TrÃ¨s sale</th><th>Fin de chantier</th></tr></thead>
            <tbody>
              <tr><td>FenÃªtre simple (int./ext.)</td><td>0.5â€“0.75h</td><td>0.75â€“1h</td><td>1â€“1.25h</td></tr>
              <tr><td>FenÃªtre double vitrage</td><td>0.75â€“1h</td><td>1â€“1.25h</td><td>1.25â€“1.5h</td></tr>
              <tr><td>Baie vitrÃ©e simple</td><td>1â€“1.5h</td><td>1.5â€“2h</td><td>2â€“2.5h</td></tr>
              <tr><td>Baie vitrÃ©e large / double</td><td>1.5â€“2h</td><td>2â€“2.5h</td><td>2.5â€“3h</td></tr>
              <tr><td>Stores Ã  lamelles (suppl.)</td><td>+0.5h</td><td>+0.75â€“1h</td><td>+1â€“1.5h</td></tr>
            </tbody>
          </table>
        </div>
      </details>
    </div>

    <div class="modal-actions">
      <button onclick="closeInfo()" class="btn white">Fermer</button>
    </div>
  </div>
</div>
</div>
</div>

</div>

</div>

</div>

</div>

</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="script.js"></script>
  <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt=e;
      document.getElementById('installBtn').classList.remove('hidden');
    });
    function promptInstall(){
      if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt.userChoice.then(()=>{ deferredPrompt=null; document.getElementById('installBtn').classList.add('hidden'); }); }
      else alert('Install not available here. Deploy over HTTPS.');
    }
    window.addEventListener('load', ()=>{ setTimeout(()=>document.getElementById('splash').classList.add('hide'), 1800); });
  </script>
</body>
</html>