<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Estimation Nettoyage</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
</head>
<body class="blue-bg">
  <div id="splash" class="splash">
    <div class="drop"></div>
    <div class="splash-title">Estimation Nettoyage</div>
  </div>

  <header>
    <div class="left">
      <button id="presetIcon" class="icon-btn" title="Pr√©-d√©finir pi√®ces" onclick="openPresets()">üî∑</button>
      <div class="brand"><div class="logo-drop"></div><span>Estimation Nettoyage</span></div>
    </div>
    <div class="right">
      <button id="infoBtn" class="icon-btn" onclick="openInfo()" title="Comment √ßa marche ?">‚ÑπÔ∏è</button>
      <button id="installBtn" class="icon-btn hidden" onclick="promptInstall()" title="Installer l‚Äôapp">‚¨áÔ∏è</button>
      <select id="langSelect" onchange="setLang(this.value)"><option value="fr">FR</option><option value="en">EN</option></select>
    </div>
  </header>

  <main>
    <div id="firstTip" class="tip hidden" data-i18n="first_tip">üí¨ Conseil : utilisez le bouton üî∑ pour d√©finir vos pi√®ces personnalis√©es (une seule fois).</div>

    <section class="card">
      <div class="row">
        <label class="flex"><span data-i18n="client">Nom client</span><input type="text" id="clientName" placeholder="Nom du client" /></label>
        <label class="flex"><span data-i18n="date">Date</span><input type="date" id="cleaningDate" /></label>
      </div>

      <div class="row">
        <label class="flex">
          <span data-i18n="type">Type de nettoyage</span>
          <div class="type-line">
            <select id="cleanType" onchange="onTypeChange()">
              <option value="Fin de chantier">Fin de chantier</option>
              <option value="Fin de bail -">Fin de bail -</option>
              <option value="Fin de bail +">Fin de bail +</option>
              <option value="Vitres & Stores">Vitres & Stores</option>
              <option value="M√©thodes">M√©thodes</option>
              <option value="Entretien r√©gulier - Administration">Entretien r√©gulier - Administration</option>
              <option value="Entretien r√©gulier - H√¥pital">Entretien r√©gulier - H√¥pital</option>
              <option value="Entretien r√©gulier - √âcoles">Entretien r√©gulier - √âcoles</option>
              <option value="Entretien r√©gulier - R√©sidence">Entretien r√©gulier - R√©sidence</option>
              <option value="Entretien r√©gulier - M√©dico-social">Entretien r√©gulier - M√©dico-social</option>
              <option value="__custom__">‚ûï Ajuster une autre</option>
            </select>
          </div>
        </label>
      </div>

      <!-- M√©thodes / Entretien : plusieurs lignes (Surface / M¬≤ = H) -->
      <div id="m2hRow" class="hidden">
        <div class="m2h-header">
          <strong id="m2hTitle">M√©thodes</strong>
          <button class="btn white small" type="button" onclick="addM2HLine()">‚ûï Ajouter</button>
        </div>
        <div id="m2hLines" class="m2h-lines"></div>
        <div class="m2h-note">
          <small>H = Surface / M¬≤ (ex: 600 / 300 = 2h)</small>
        </div>
      </div>

      <button id="toggleAdjuster" class="toggle-btn" onclick="toggleAdjuster()">+ Ajuster</button>
      <div id="adjuster" class="adjuster hidden">
        <div class="pieces-chooser">
          <h3 data-i18n="pieces">Pi√®ces (pr√©-definitions)</h3>
          <div id="standardList" class="standard-list"></div>
        </div>

        <div class="custom-piece">
          <h3 data-i18n="add_custom">Ajouter pi√®ce personnalis√©e</h3>
          <input type="text" id="customPieceName" placeholder="Nom (ex: Jardin d'hiver)">
          <input type="number" id="customPieceTime" placeholder="Temps par unit√© (h)" step="0.01" min="0">
          <input type="number" id="customPieceQty" placeholder="Quantit√©" step="1" min="1" value="1">
          <button class="btn" onclick="addCustomPiece()">Ajouter</button>
        </div>

        <div class="piece-list-container">
          <h3 data-i18n="list">Liste des pi√®ces</h3>
          <ul id="pieceList"></ul>
        </div>
      </div>

      <div class="total-section">
        <h2><span data-i18n="total">Total estim√© :</span> <span id="totalHours">0.00</span> h</h2>
        <div class="team-line">
          <label class="team-label">√âquipe :</label>
          <span id="teamCalc"><span id="teamTotal">0.00</span> / <input id="hoursPerPerson" class="team-input" type="number" min="0" step="0.1" value="9"> = <span id="teamPeople">0.00</span></span>
        </div>
      </div>

      <div class="row">
        <label class="flex">
          <span data-i18n="remarks">Remarques :</span>
          <textarea id="remarks" placeholder="Remarques..."></textarea>
        </label>
      </div>

      <div class="actions">
        <button class="btn white" onclick="generatePDF()">PDF</button>
        <button class="btn white" onclick="resetForm()">R√©initialiser</button>
      </div>
    </section>
  </main>

  <div id="presetsModal" class="modal hidden">
    <div class="modal-content">
      <h2 data-i18n="presets_title">Pr√©-d√©finir pi√®ces</h2>
      <div class="tabs">
        <button class="tab-btn active" data-tab="Fin de chantier" onclick="switchTab('Fin de chantier')">Fin de chantier</button>
        <button class="tab-btn" data-tab="Fin de bail -" onclick="switchTab('Fin de bail -')">Fin de bail -</button>
        <button class="tab-btn" data-tab="Fin de bail +" onclick="switchTab('Fin de bail +')">Fin de bail +</button>
        <button class="tab-btn" data-tab="Vitres & Stores" onclick="switchTab('Vitres & Stores')">Vitres & Stores</button>
        <button class="tab-btn" data-tab="M√©thodes" onclick="switchTab('M√©thodes')">M√©thodes</button>
        <button class="tab-btn" data-tab="Entretien r√©gulier - Administration" onclick="switchTab('Entretien r√©gulier - Administration')">Entretien - Administration</button>
        <button class="tab-btn" data-tab="Entretien r√©gulier - H√¥pital" onclick="switchTab('Entretien r√©gulier - H√¥pital')">Entretien - H√¥pital</button>
        <button class="tab-btn" data-tab="Entretien r√©gulier - √âcoles" onclick="switchTab('Entretien r√©gulier - √âcoles')">Entretien - √âcoles</button>
        <button class="tab-btn" data-tab="Entretien r√©gulier - R√©sidence" onclick="switchTab('Entretien r√©gulier - R√©sidence')">Entretien - R√©sidence</button>
        <button class="tab-btn" data-tab="Entretien r√©gulier - M√©dico-social" onclick="switchTab('Entretien r√©gulier - M√©dico-social')">Entretien - M√©dico-social</button>
      </div>

      <div id="presetList" class="preset-list"></div>
      <div class="preset-add">
        <input type="text" id="presetName" placeholder="Nom pi√®ce (ex: Cuisine)">
        <input type="number" id="presetTime" placeholder="Temps (h)" step="0.01" min="0">
        <input type="number" id="presetM2" class="hidden" placeholder="M¬≤ (ex: 300)" step="0.1" min="0">
        <button class="btn" onclick="addPreset()">Ajouter</button>
      </div>
      <div class="separator"></div>
      <div class="custom-type">
        <h3>‚ûï <span data-i18n="add_type">Cr√©er un type personnalis√©</span></h3>
        <div class="row">
          <input type="text" id="newTypeName" placeholder="Ex: Nettoyage vitres">
          <button class="btn" onclick="createCustomType()">Cr√©er</button>
        </div>
      </div>
      <div class="modal-actions">
        <button onclick="savePresets()" class="btn white">Enregistrer</button>
        <button onclick="closePresets()" class="btn white">Fermer</button>
        <button onclick="clearAllPresets()" class="btn white danger">Effacer tout presets</button>
      </div>
    </div>
  </div>

  <div id="infoModal" class="modal hidden">
    <div class="modal-content">
      <h2>‚ÑπÔ∏è Comment √ßa marche ?</h2>
      <div class="info-text">
        <p><strong>1)</strong> Choisis le type d‚Äôintervention (Fin de chantier / Fin de bail - / Fin de bail + / etc.).</p>
        <p><strong>2)</strong> Ajoute des pi√®ces avec <strong>+ Ajuster</strong> (ou via les pr√©-d√©finitions üî∑).</p>
        <p><strong>3)</strong> Pour <strong>M√©thodes</strong> et <strong>Entretien r√©gulier</strong> : s√©lectionne un nom + sa capacit√© (M¬≤) puis saisis la <strong>surface</strong>.
           Le temps est calcul√© automatiquement : <em>H = Surface / M¬≤</em> (ex: 600 / 300 = 2h). Tu peux aussi saisir H manuellement.</p>
        <p><strong>4)</strong> G√©n√®re le PDF avec le bouton <strong>PDF</strong>.</p>
        <p><strong>Dans le PDF</strong> : client, date, type, liste des pi√®ces et total (heures), remarques.</p>
      </div>
      <div class="modal-actions">
        <button onclick="closeInfo()" class="btn white">Fermer</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="script.js"></script>
  <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt=e;
      document.getElementById('installBtn').classList.remove('hidden');
    });
    function promptInstall(){
      if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt.userChoice.then(()=>{ deferredPrompt=null; document.getElementById('installBtn').classList.add('hidden'); }); }
      else alert('Install not available here. Deploy over HTTPS.');
    }
    window.addEventListener('load', ()=>{ setTimeout(()=>document.getElementById('splash').classList.add('hide'), 1800); });
  </script>
</body>
</html>
