<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#339CFF" />
  <title>Estimation Nettoyage</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="./icons/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="./icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <link rel="stylesheet" href="style.css?v=200">
</head>
<body class="blue-bg">
  <div id="splash" class="splash">
    <div class="drop"></div>
    <div class="splash-title">Estimation Nettoyage</div>
  </div>

  <header>
    <div class="left">
      <button id="presetIcon" class="icon-btn" data-i18n-title="t_predefine" title="Pr√©-d√©finir pi√®ces" onclick="openPresets()">üî∑</button>
      <div class="brand"><div class="logo-drop"></div><span>Estimation Nettoyage</span></div>
    </div>
    <div class="right">
      <button id="infoBtn" class="icon-btn" onclick="openInfo()" data-i18n-title="t_info" title="Comment √ßa marche ?">‚ÑπÔ∏è</button>
      <button id="typesBtn" class="icon-btn" onclick="openTypeManager()" data-i18n-title="t_types" title="Gestion des types">‚öôÔ∏è</button>
      <button id="installBtn" class="icon-btn hidden" onclick="promptInstall()" data-i18n-title="t_install" title="Installer l‚Äôapp">‚¨áÔ∏è</button>
      <select id="langSelect" onchange="setLang(this.value)"><option value="fr">FR</option><option value="en">EN</option><option value="de">DE</option></select>
    </div>
  </header>

  <main>
    <nav class="subnav">
      <button class="btn white small" type="button" onclick="openTypeManager()" data-i18n="sub_types">‚öôÔ∏è Gestion des types</button>
    </nav>
    <div id="firstTip" class="tip hidden" data-i18n="first_tip">üí¨ Conseil : utilisez le bouton üî∑ pour d√©finir vos pi√®ces personnalis√©es (une seule fois).</div>

    <section class="card">
      <div class="row">
        <label class="flex"><span data-i18n="client">Nom client</span><input type="text" id="clientName" data-i18n-placeholder="ph_client" placeholder="Nom du client" /></label>
        <label class="flex"><span data-i18n="date">Date</span><input type="date" id="cleaningDate" /></label>
      </div>

      <div class="row">
        <label class="flex">
          <span data-i18n="type">Type de nettoyage</span>
          <div class="type-line">
            <select id="cleanType" onchange="onTypeChange()">
              <option value="Fin de chantier">Fin de chantier</option>
              <option value="Fin de bail -">Fin de bail -</option>
              <option value="Fin de bail +">Fin de bail +</option>
              <option value="Vitres & Stores">Vitres & Stores</option>
              <option value="M√©thodes">M√©thodes</option>
              <option value="Entretien r√©gulier - Administration">Entretien r√©gulier - Administration</option>
              <option value="Entretien r√©gulier - H√¥pital">Entretien r√©gulier - H√¥pital</option>
              <option value="Entretien r√©gulier - √âcoles">Entretien r√©gulier - √âcoles</option>
              <option value="Entretien r√©gulier - R√©sidence">Entretien r√©gulier - R√©sidence</option>
              <option value="Entretien r√©gulier - M√©dico-social">Entretien r√©gulier - M√©dico-social</option>
              <option value="__custom__">‚ûï Ajuster une autre</option>
            </select>
<select id="globalCoefSelect" class="hidden"></select>
          </div>
        </label>
      </div>

      <!-- M√©thodes / Entretien : plusieurs lignes (Surface / M¬≤ = H) -->
      <div id="m2hRow" class="hidden">
        <div class="m2h-header">
          <strong id="m2hTitle">M√©thodes</strong>
          <button class="btn white small" type="button" onclick="addM2HLine()" data-i18n="btn_add">‚ûï Ajouter</button>
        </div>
        <div id="m2hLines" class="m2h-lines"></div>
        <div class="m2h-note">
          <small>H = Surface / M¬≤ (ex: 600 / 300 = 2h)</small>
        </div>
      </div>

      <button id="toggleAdjuster" class="toggle-btn" onclick="toggleAdjuster()" data-i18n="btn_adjust">+ Ajuster</button>
      <div id="adjuster" class="adjuster hidden">
        <div class="pieces-chooser">
          <h3 data-i18n="pieces">Pi√®ces (pr√©-definitions)</h3>

          <!-- ‚úÖ Vitres & Stores : Unit√©s + M¬≤ (avec difficult√©) -->
          <div id="vitresWrap" class="vitres-wrap hidden">
            <div class="vitres-grid">
              <div class="vbox">
                <h4>Unit√©s</h4>
                <select id="vit_u_preset"></select>
                <input id="vit_u_time" type="number" step="0.01" min="0" placeholder="Temps par unit√© (h)">
                <div class="vrow">
                  <input id="vit_u_norm" type="number" step="1" min="0" placeholder="Quantit√© normale">
                  <input id="vit_u_diff" type="number" step="1" min="0" placeholder="Quantit√© difficile">
                </div>
                <select id="vit_u_coef">
                  <option value="0">Difficult√© 0%</option>
                  <option value="0.2">Difficult√© 20%</option>
                  <option value="0.3">Difficult√© 30%</option>
                </select>
              </div>

              <div class="vbox">
                <h4>M¬≤</h4>
                <select id="vit_m2_preset"></select>
                <input id="vit_m2_cap" type="number" step="0.1" min="0" placeholder="Capacit√© (m¬≤/h)">
                <div class="vrow">
                  <input id="vit_m2_norm" type="number" step="0.1" min="0" placeholder="M¬≤ normal">
                  <input id="vit_m2_diff" type="number" step="0.1" min="0" placeholder="M¬≤ difficile">
                </div>
                <select id="vit_m2_coef">
                  <option value="0">Difficult√© 0%</option>
                  <option value="0.2">Difficult√© 20%</option>
                  <option value="0.3">Difficult√© 30%</option>
                </select>
              </div>
            </div>
            <div class="vitres-actions">
              <button class="btn" type="button" onclick="addVitresToSession()" data-i18n="btn_add_session" data-i18n="btn_add_session">Ajouter √† la session</button>
            </div>
          </div>

          <div id="standardList" class="standard-list"></div>
        </div>

        <div class="custom-piece">
          <h3 data-i18n="add_custom">Ajouter pi√®ce personnalis√©e</h3>
          <input type="text" id="customPieceName" data-i18n-placeholder="ph_custom_name" placeholder="Nom (ex: Jardin d'hiver)">
          <input type="number" id="customPieceTime" data-i18n-placeholder="ph_custom_time" placeholder="Temps par unit√© (h)" step="0.01" min="0">
          <input type="number" id="customPieceQty" data-i18n-placeholder="ph_custom_qty" placeholder="Quantit√©" step="1" min="1" value="1">
          <button class="btn" onclick="addCustomPiece()" data-i18n="btn_add_plain">Ajouter</button>
        </div>

        <div class="piece-list-container">
          <h3 data-i18n="list">Liste des pi√®ces</h3>
          <ul id="pieceList"></ul>
        </div>
      </div>

      <div class="total-section">
        <h2><span data-i18n="total">Total estim√© :</span> <span id="totalHours">0.00 (0:00h)</span></h2>
        <div class="team-line">
          <label class="team-label" data-i18n="team">√âquipe :</label>
          <span id="teamCalc"><span id="teamTotal">0.00 (0:00h)</span> / <input id="hoursPerPerson" class="team-input" type="number" min="0" step="0.1" value="9"> = <span id="teamPeople">0.00</span></span>
        </div>
      </div>

      <div class="row">
        <label class="flex">
          <span data-i18n="remarks">Remarques :</span>
          <textarea id="remarks" data-i18n-placeholder="ph_remarks" placeholder="Remarques..."></textarea>
        </label>
      </div>

      <div class="actions">
        <button class="btn white" onclick="generatePDF()" data-i18n="btn_pdf">PDF</button>
        <button class="btn white" onclick="resetForm()" data-i18n="btn_reset">R√©initialiser</button>
      </div>
    </section>
  </main>

  <div id="presetsModal" class="modal hidden">
    <div class="modal-content">
      <h2 data-i18n="presets_title">Pr√©-d√©finir pi√®ces</h2>
      <div class="tabs" id="presetTabs">
        <button class="tab-btn active" data-tab="Fin de chantier" onclick="switchTab('Fin de chantier')">Fin de chantier</button>
        <button class="tab-btn" data-tab="Fin de bail -" onclick="switchTab('Fin de bail -')">Fin de bail -</button>
        <button class="tab-btn" data-tab="Fin de bail +" onclick="switchTab('Fin de bail +')">Fin de bail +</button>
        <button class="tab-btn" data-tab="Vitres & Stores" onclick="switchTab('Vitres & Stores')">Vitres & Stores</button>
        <button class="tab-btn" data-tab="M√©thodes" onclick="switchTab('M√©thodes')">M√©thodes</button>
        <button class="tab-btn" data-tab="Entretien r√©gulier - Administration" onclick="switchTab('Entretien r√©gulier - Administration')">Entretien - Administration</button>
        <button class="tab-btn" data-tab="Entretien r√©gulier - H√¥pital" onclick="switchTab('Entretien r√©gulier - H√¥pital')">Entretien - H√¥pital</button>
        <button class="tab-btn" data-tab="Entretien r√©gulier - √âcoles" onclick="switchTab('Entretien r√©gulier - √âcoles')">Entretien - √âcoles</button>
        <button class="tab-btn" data-tab="Entretien r√©gulier - R√©sidence" onclick="switchTab('Entretien r√©gulier - R√©sidence')">Entretien - R√©sidence</button>
        <button class="tab-btn" data-tab="Entretien r√©gulier - M√©dico-social" onclick="switchTab('Entretien r√©gulier - M√©dico-social')">Entretien - M√©dico-social</button>
      </div>

      <!-- ‚úÖ Biblioth√®que (cat√©gories) : uniquement pour Fin de chantier / Fin de bail - / Fin de bail + -->
      <div id="biblioWrap" class="biblio-wrap hidden">
        <div class="biblio-grid">
          <div class="biblio-left">
            <div class="biblio-head">
              <strong>Biblioth√®que</strong>
              <button class="btn small" type="button" onclick="biblioAddCategory()">+ Cat√©gorie</button>
            </div>
            <div id="biblioCats" class="biblio-cats"></div>
          </div>

          <div class="biblio-right">
            <div class="biblio-head">
              <strong id="biblioCatTitle">‚Äî</strong>
              <button class="btn small" type="button" onclick="biblioAddItem()">+ Item</button>
            </div>
            <div id="biblioItems" class="biblio-items"></div>
          </div>
        </div>
      </div>

      <div id="presetList" class="preset-list"></div>
      <div class="preset-add">
        <input type="text" id="presetName" data-i18n-placeholder="res_piece_name_ph" placeholder="Nom pi√®ce (ex: Cuisine)">
        <select id="presetKind" class="hidden">
          <option value="unit">Unit√©s</option>
          <option value="m2">M¬≤/h</option>
        </select>
        <input type="number" id="presetTime" data-i18n-placeholder="res_piece_time_ph" placeholder="Temps (h)" step="0.01" min="0">
        <input type="number" id="presetM2" class="hidden" placeholder="M¬≤ (ex: 300)" step="0.1" min="0">
        <button class="btn" onclick="addPreset()" data-i18n="btn_add_plain">Ajouter</button>
      </div>

      <!-- ‚úÖ Entretien - R√©sidence : pi√®ces unitaires (en plus des lignes M¬≤ sur la page principale) -->
      <div id="resPiecesWrap" class="hidden">
        <div class="separator"></div>
        <h3>Entretien - R√©sidence : Pi√®ces (unit√©s)</h3>
        <div id="resPieceList" class="preset-list"></div>
        <div class="preset-add">
          <input type="text" id="resPieceName" data-i18n-placeholder="res_piece_name_ph" placeholder="Nom pi√®ce (ex: Cuisine)">
          <input type="number" id="resPieceTime" data-i18n-placeholder="res_piece_time_ph" placeholder="Temps (h)" step="0.01" min="0">
          <button class="btn" type="button" onclick="addResidencePiecePreset()"><span data-i18n="btn_add">Ajouter</span></button>
        </div>
      </div>
      <div class="modal-actions">
        <button onclick="savePresets()" class="btn white" data-i18n="btn_save">Enregistrer</button>
        <button onclick="closePresets()" class="btn white" data-i18n="close">Fermer</button>
        <button onclick="clearAllPresets()" class="btn white danger" data-i18n="btn_clear_all">Effacer tout presets</button>
      </div>
    </div>
  </div>

  
<div id="typesModal" class="modal hidden">
  <div class="modal-content modal-scroll">
    <div class="modal-head">
      <h2 data-i18n="tm_title">‚öôÔ∏è Gestion des types</h2>
      <button class="btn white small" type="button" onclick="closeTypeManager()" data-i18n="close">Fermer</button>
    </div>

    <div class="type-manager">
      <div class="type-create">
        <h3 data-i18n="tm_create_h">‚ûï Cr√©er un type</h3>
        <div class="row">
          <input type="text" id="tm_name" data-i18n-placeholder="tm_name_ph" placeholder="Ex: Restaurant">
          <select id="tm_template">
            <option value="vitres" data-i18n="tm_tpl_vitres">Mod√®le 2 blocs (comme Vitres)</option>
            <option value="m2h" data-i18n="tm_tpl_m2h">M√©thodes / Entretien (Surface / M¬≤)</option>
            <option value="pieces_biblio" data-i18n="tm_tpl_biblio">Pi√®ces (biblioth√®que)</option>
          </select>
        </div>
        <div class="row">
          <label class="check"><input type="checkbox" id="tm_opt_pieces" checked> <span data-i18n="tm_opt_pieces">Pi√®ces (bloc gauche)</span></label>
          <label class="check"><input type="checkbox" id="tm_opt_m2" checked> <span data-i18n="tm_opt_m2">M¬≤/h (bloc droite)</span></label>
          <label class="check"><input type="checkbox" id="tm_opt_coef" checked> <span data-i18n="tm_opt_coef">Coef %</span></label>
        </div>
        <div class="row">
          <input type="number" id="tm_coef" step="1" min="0" data-i18n-placeholder="tm_coef_ph" placeholder="Coef % (ex: 20)">
          <input type="number" id="tm_d1" step="1" min="0" data-i18n-placeholder="tm_d1_ph" placeholder="Difficult√© 1 % (ex: 20)">
          <input type="number" id="tm_d2" step="1" min="0" data-i18n-placeholder="tm_d2_ph" placeholder="Difficult√© 2 % (ex: 30)">
        </div>
        <button class="btn" type="button" onclick="tmCreate()" data-i18n="tm_btn_create">Cr√©er</button>
      </div>

      <div class="separator"></div>

      <div>
        <h3 data-i18n="tm_existing_h">Types existants</h3>
        <div id="tm_list" class="tm-list"></div>
        <small data-i18n="tm_hint">üí° D√©sactiver = dispara√Æt du menu, mais reste enregistr√©.</small>
      </div>
    </div>
  </div>
</div>

<div id="infoModal" class="modal hidden">
  <div class="modal-content info-modal">
    <div class="modal-head">
      <h2 data-i18n="info_h">‚ÑπÔ∏è Guide ‚Äì Comment remplir (Pi√®ces + m¬≤/h)</h2>
      <button onclick="closeInfo()" class="btn white small" type="button" data-i18n="close">Fermer</button>
    </div>
    <div id="infoContent" data-i18n-html="info_html"></div>

    <div class="modal-actions">
      <button onclick="closeInfo()" class="btn white" data-i18n="close">Fermer</button>
    </div>
  </div>
</div>
</div>
</div>

</div>

</div>

</div>

</div>

</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="script.js"></script>
  <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt=e;
      document.getElementById('installBtn').classList.remove('hidden');
    });
    function promptInstall(){
      if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt.userChoice.then(()=>{ deferredPrompt=null; document.getElementById('installBtn').classList.add('hidden'); }); }
      else alert('Install not available here. Deploy over HTTPS.');
    }
    window.addEventListener('load', ()=>{ setTimeout(()=>document.getElementById('splash').classList.add('hide'), 1800); });
  </script>
</body>
</html>